<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP地址查询工具</title>
    <link rel="icon" href="https://vip.123pan.cn/1813813253/cdn/logo/1.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .glass {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        #query-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* Map Styles */
        #map {
            height: 200px;
            border-radius: 0.75rem; /* 12px */
            z-index: 0; /* Ensure it's behind popups */
            background-color: #e5e7eb; /* light gray bg for map loading */
        }
        .dark #map {
             background-color: #374151; /* dark gray bg for map loading */
        }
        .leaflet-control-attribution a {
            color: #4f46e5 !important; /* Indigo-600 */
        }
        .dark .leaflet-control-attribution a {
             color: #818cf8 !important; /* Indigo-400 */
        }
        .leaflet-tile-pane {
            filter: brightness(1.05);
        }
        .dark .leaflet-tile-pane {
             filter: brightness(0.9) invert(1) grayscale(0.4);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-gray-100 dark:bg-slate-900 transition-colors duration-300">

    <div class="w-full max-w-md">
        <!-- 主应用容器 -->
        <div class="w-full rounded-3xl p-6 space-y-5
                    glass bg-white/90 border border-gray-200/80 text-slate-800 shadow-2xl shadow-gray-200/80
                    dark:bg-gray-800/60 dark:border-white/20 dark:text-white dark:shadow-2xl dark:shadow-black/20">

            <h1 class="text-3xl font-bold text-center tracking-wider">IP 查询工具</h1>
            
            <!-- 查询输入框 -->
            <div class="flex items-center gap-3">
                <input type="text" id="ip-input" placeholder="输入IP地址，留空则查自己" 
                       class="w-full px-4 py-3 bg-white/80 border border-gray-300 rounded-xl 
                              focus:ring-2 focus:ring-indigo-500 focus:outline-none transition 
                              placeholder:text-gray-500
                              dark:bg-white/10 dark:border-white/20 dark:focus:ring-white/50 
                              dark:placeholder:text-gray-300">
                <button id="query-btn" 
                        class="px-5 py-3 font-semibold text-white bg-indigo-500 rounded-xl 
                               hover:bg-indigo-600 active:scale-95 transition-all duration-150
                               dark:bg-white/20 dark:hover:bg-white/30 flex items-center justify-center w-28">
                    <span>查询</span>
                </button>
            </div>

            <!-- 分割线 -->
            <hr class="border-gray-200 dark:border-white/10 !my-6">

            <!-- 结果显示区 -->
            <div id="results-wrapper" class="space-y-4 pt-1">
                 <div id="result-container" class="space-y-2">
                    <div id="status" class="text-center py-10">
                        <p class="text-lg text-slate-600 dark:text-white/80">请输入IP地址进行查询</p>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center text-xs text-gray-500 dark:text-gray-600 mt-4">
            IP 地理位置数据由 <a href="https://ipinfo.io" target="_blank" rel="noopener noreferrer" class="underline hover:text-indigo-500">ipinfo.io</a> 提供
        </footer>
    </div>


    <script>
        const ipInput = document.getElementById('ip-input');
        const queryBtn = document.getElementById('query-btn');
        const resultsWrapper = document.getElementById('results-wrapper');
        const resultContainer = document.getElementById('result-container');
        
        let map = null;

        const icons = { '运营商': `<svg ...></svg>`, '时区': `<svg ...></svg>` }; // Icons kept minimal for brevity
        const copyIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-60 group-hover:opacity-100 transition"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
        const checkIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M20 6 9 17l-5-5"/></svg>`;
        
        const initOrUpdateMap = (lat, lon) => {
            let mapContainer = document.getElementById('map');
            if (!mapContainer) {
                mapContainer = document.createElement('div');
                mapContainer.id = 'map';
                mapContainer.className = 'fade-in';
                resultsWrapper.prepend(mapContainer);
            }
            mapContainer.style.display = 'block';

            if (map) {
                map.setView([lat, lon], 13);
            } else {
                map = L.map('map').setView([lat, lon], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
            }
            L.marker([lat, lon]).addTo(map);
        };

        const hideMap = () => {
            const mapContainer = document.getElementById('map');
            if (mapContainer) mapContainer.style.display = 'none';
        };

        const copyToClipboard = (text, buttonEl) => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            buttonEl.innerHTML = checkIconSVG;
            setTimeout(() => { buttonEl.innerHTML = copyIconSVG; }, 1500);
        };

        const displayResults = (data) => {
            resultContainer.innerHTML = ''; // Clear previous results

            // --- IP and Location ---
            const mainInfoHTML = `
                <div class="fade-in p-4 bg-indigo-50 dark:bg-indigo-500/10 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="text-slate-500 dark:text-indigo-200 text-sm">IP Address</span>
                        <button id="copy-btn" class="p-1 rounded-md hover:bg-black/10 dark:hover:bg-white/10 group transition">${copyIconSVG}</button>
                    </div>
                    <p class="text-2xl font-bold text-slate-800 dark:text-white break-all">${data.ip || 'N/A'}</p>
                </div>
                <div class="fade-in p-4 bg-black/5 dark:bg-white/5 rounded-lg" style="animation-delay: 50ms;">
                    <span class="text-slate-500 dark:text-white/60 text-sm">Location</span>
                    <p class="text-lg font-semibold text-slate-800 dark:text-white">${[data.city, data.region, data.country].filter(Boolean).join(', ') || 'N/A'}</p>
                </div>
            `;
            resultContainer.innerHTML += mainInfoHTML;
            document.getElementById('copy-btn').onclick = (e) => copyToClipboard(data.ip, e.currentTarget);

            // --- Other Details ---
            const otherDetailsHTML = `
                <div class="fade-in grid grid-cols-1 sm:grid-cols-2 gap-2 pt-2" style="animation-delay: 100ms;">
                    <div class="p-3 bg-black/5 dark:bg-white/5 rounded-lg">
                        <span class="text-sm text-slate-500 dark:text-white/60">运营商</span>
                        <p class="font-medium text-slate-700 dark:text-white/90">${data.org || 'N/A'}</p>
                    </div>
                    <div class="p-3 bg-black/5 dark:bg-white/5 rounded-lg">
                        <span class="text-sm text-slate-500 dark:text-white/60">时区</span>
                        <p class="font-medium text-slate-700 dark:text-white/90">${data.timezone || 'N/A'}</p>
                    </div>
                </div>
            `;
            resultContainer.innerHTML += otherDetailsHTML;

            if (data.loc) {
                try {
                    const [lat, lon] = data.loc.split(',');
                    initOrUpdateMap(parseFloat(lat), parseFloat(lon));
                } catch(e) {
                    console.error("Could not parse location for map:", e);
                    hideMap();
                }
            } else {
                hideMap();
            }
        };

        const showStatusMessage = (message, isError = false) => {
            hideMap();
            resultContainer.innerHTML = `<div id="status" class="text-center py-10"><p class="text-lg ${isError ? 'text-red-500 dark:text-red-400' : 'text-slate-600 dark:text-white/80'}">${message}</p></div>`;
        };

        const queryIP = async (ip = '') => {
            showStatusMessage('正在查询...');
            queryBtn.disabled = true;
            queryBtn.innerHTML = `<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            
            try {
                const response = await fetch(`https://ipinfo.io/${ip}/json`);
                if (!response.ok) {
                    if (response.status === 404) throw new Error('找不到该IP地址的信息。');
                    if (response.status === 429) throw new Error('请求过于频繁，请稍后再试。');
                    throw new Error(`网络请求失败 (${response.status})`);
                }
                const data = await response.json();
                if (data.bogon) throw new Error('这是一个保留或无效的IP地址。');
                ipInput.value = data.ip;
                displayResults(data);
            } catch (error) {
                showStatusMessage(error.message, true);
            } finally {
                queryBtn.disabled = false;
                queryBtn.innerHTML = `<span>查询</span>`;
            }
        };

        queryBtn.addEventListener('click', () => queryIP(ipInput.value.trim()));
        ipInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') queryIP(ipInput.value.trim());
        });

        window.addEventListener('load', () => {
            setTimeout(() => queryIP(), 100);
        });
    </script>
</body>
</html>

