<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 忘了出自哪了，也是改的 -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
	<title>Redfox 幻影坦克生成</title>
    <link rel="icon" href="https://vip.123pan.cn/1813813253/cdn/logo/logo.png" type="image/png">
	<style>
        :root {
            --bg-color: #111;
            --card-bg: #222;
            --text-main: #eee;
            --primary: #0066cc;
            --border: #333;
        }

        * { box-sizing: border-box; }
        
		body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: "Segoe UI", sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
		}

        h1 { color: #fff; border-left: 4px solid var(--primary); padding-left: 15px; margin-bottom: 20px; }
        
        .container { max-width: 800px; width: 100%; }
        
        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .tip-box {
            background: rgba(0, 102, 204, 0.1);
            border: 1px solid var(--primary);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #ccc;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .upload-grid { grid-template-columns: 1fr; }
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            background: #1a1a1a;
            transition: border-color 0.3s;
            cursor: pointer;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-area:hover { border-color: var(--primary); }

        .upload-area img {
            max-width: 100%;
            max-height: 200px;
            display: none;
            border-radius: 4px;
            margin-top: 10px;
        }

        .upload-label {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
            display: block;
        }

        .upload-desc { font-size: 12px; color: #666; }

        input[type="file"] { display: none; }

        button {
            width: 100%;
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0052a3; }

        #out {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid #444;
            background-image: linear-gradient(45deg, #333 25%, transparent 25%), linear-gradient(-45deg, #333 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #333 75%), linear-gradient(-45deg, transparent 75%, #333 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            display: none;
            margin-top: 20px;
        }
        
        .result-area { text-align: center; }
	</style>
</head>
<body>
    <div class="container">
        <h1>幻影坦克生成器</h1>
        
        <div class="tip-box">
            <strong>使用指南：</strong><br>
            1. <b>表图（亮）：</b> 在白色背景下显示的图片（建议调高曝光）。<br>
            2. <b>里图（暗）：</b> 在黑色背景下显示的图片（建议黑白，调低曝光）。<br>
            3. 生成后点击图片即可预览，长按或右键保存。
        </div>

        <div class="upload-grid">
            <label class="upload-area">
                <span class="upload-label">上传表图 (亮)</span>
                <span class="upload-desc">点击选择图片</span>
                <img id="preview1">
                <input id="in1" type="file" accept="image/*">
            </label>
            
            <label class="upload-area">
                <span class="upload-label">上传里图 (暗)</span>
                <span class="upload-desc">点击选择图片</span>
                <img id="preview2">
                <input id="in2" type="file" accept="image/*">
            </label>
        </div>

        <button id="run">开始生成</button>

        <div class="result-area">
            <img id="out" />
            <p id="done-msg" style="display:none; color:#00a8ff; margin-top:10px;">生成完毕！请保存上方图片。</p>
        </div>
    </div>

	<script type="text/javascript">
		var img1 = document.createElement('img')
		var img2 = document.createElement('img')
		var in1 = document.getElementById('in1')
		var in2 = document.getElementById('in2')
		var run = document.getElementById('run')
        
        // 增加预览功能
        function handleFileSelect(input, imgObj, previewId) {
            input.addEventListener('change', function () {
                var reader = new FileReader()
                reader.onload = function () {
                    imgObj.src = reader.result
                    var preview = document.getElementById(previewId);
                    preview.src = reader.result;
                    preview.style.display = 'block';
                    // 隐藏提示文字
                    input.parentElement.querySelector('.upload-desc').style.display = 'none';
                }
                if(input.files[0]) reader.readAsDataURL(input.files[0])
            })
        }

        handleFileSelect(in1, img1, 'preview1');
        handleFileSelect(in2, img2, 'preview2');

		run.addEventListener('click', function () {
            if (!img1.src || !img2.src) {
                alert("请确保两张图片都已上传！");
                return;
            }
            
            run.innerText = "生成中...";
            
            // 使用 setTimeout 让 UI 有机会刷新显示“生成中”
            setTimeout(() => {
                var c = document.createElement('canvas')
                c.width = img1.width
                c.height = img1.height
                var ctx = c.getContext("2d")
                ctx.drawImage(img1, 0, 0)
                var data1 = ctx.getImageData(0, 0, c.width, c.height)
                ctx.drawImage(img2, 0, 0, c.width, c.height)
                var data2 = ctx.getImageData(0, 0, c.width, c.height)
                var data3 = ctx.createImageData(c.width, c.height)
                var i = 0
                var len = data1.data.length
                var R1, G1, B1, avg1 //亮
                var R2, G2, B2, avg2 //暗
                var R3, G3, B3, A3 //输出
                for (; i < len; i += 4) {
                    R1 = data1.data[i + 0]
                    G1 = data1.data[i + 1]
                    B1 = data1.data[i + 2]
                    avg1 = (R1 + G1 + B1) / 3
                    R2 = data2.data[i + 0]
                    G2 = data2.data[i + 1]
                    B2 = data2.data[i + 2]
                    avg2 = (R2 + G2 + B2) / 3
                    A3 = avg2 - avg1 + 255
                    if (A3 === 0) { A3 = 0.0001 }
                    R3 = R2 * 255 / A3
                    G3 = G2 * 255 / A3
                    B3 = B2 * 255 / A3
                    data3.data[i + 0] = R3
                    data3.data[i + 1] = G3
                    data3.data[i + 2] = B3
                    data3.data[i + 3] = A3
                }
                ctx.putImageData(data3, 0, 0)
                var outImg = document.getElementById('out');
                outImg.src = c.toDataURL("image/png")
                outImg.style.display = 'block';
                document.getElementById('done-msg').style.display = 'block';
                run.innerText = "重新生成";
            }, 50);
		})
	</script>
</body>
</html>